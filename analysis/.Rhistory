if (level == 7) {
cormat = matrix(nrow = length(data) + 1, ncol = length(data) + 1)
signif_mat = matrix(nrow = length(data) + 1, ncol = length(data) + 1)
} else {
cormat = matrix(nrow = length(data), ncol = length(data))
signif_mat = matrix(nrow = length(data), ncol = length(data))
}
for (i in 1:length(data)) {
for (j in 1:length(data)) {
if (i <= j) {
mantel_out <- run_bc_mantel(profiles[[i]], profiles[[j]])
cormat[i,j] <- mantel_out[1]
signif_mat[i,j] <- mantel_out[2]
}
}
}
if (level == 7) {
simka = read.csv(paste0("real_data_outputs/inputs/", dataset, "/Simka/mat_abundance_braycurtis.csv"), sep = ";")
# Simka columns are ordered by accession number and the profiles are too.  Centrifuge will always have all columns
colnames(simka) <- colnames(profiles[[1]])
for (i in 1:(ncol(cormat) - 1)) {
mantel_out <- run_bc_mantel(simka, profiles[[i]])
cormat[i,ncol(cormat)] <- mantel_out[1]
signif_mat[i,ncol(cormat)] <- mantel_out[2]
}
mantel_out <- run_bc_mantel(simka, simka)
cormat[nrow(cormat),ncol(cormat)] <- mantel_out[1]
signif_mat[nrow(cormat),ncol(cormat)] <- mantel_out[2]
}
colnames(cormat) <- tool_names
rownames(cormat) <- tool_names
colnames(signif_mat) <- tool_names
rownames(signif_mat) <- tool_names
melted_cormat <- melt(get_upper_tri(cormat), na.rm = T)
melted_signif <- melt(get_upper_tri(signif_mat), na.rm = T)
melted_signif$value <- case_when(melted_signif$value < 0.001 ~ "***",
melted_signif$value < 0.01 ~ "**",
melted_signif$value < 0.05 ~ "*",
TRUE ~ "")
melted_cormat$stars <- melted_signif$value
}
melted_cormat <- melted_cormat[order(melted_cormat$Var2),]
melted_cormat <- melted_cormat[order(melted_cormat$Var1),]
if (core_only) {
melted_cormat <- melted_cormat[melted_cormat$Var1 %in% c(tool_core, "Simka") & melted_cormat$Var2 %in% c(tool_core, "Simka"),]
}
melted_cormat <- melted_cormat[melted_cormat$Var1 != melted_cormat$Var2,]
level_name <- case_when(level == 1 ~ "kingdom",
level == 2 ~ "phylum",
level == 3 ~ "class",
level == 4 ~ "order",
level == 5 ~ "family",
level == 6 ~ "genus",
level == 7 ~ "species")
if (sum(melted_cormat$value < 0, na.rm = T) > 0) {
scale_fill_special <- scale_fill_gradient2(low = "blue", high = "red", mid = "white", midpoint = 0,
limit = c(min(melted_cormat$value) * 1.1 ,max(melted_cormat$value) * 1.1), space = "Lab",
name="Mantel r")
} else {
scale_fill_special <- scale_fill_gradient2(low = "white", high = "red", mid = "#FFBBBB", midpoint = mean(c(min(melted_cormat$value),max(melted_cormat$value))),
limit = c(min(melted_cormat$value) * 0.9,max(melted_cormat$value) * 1.1), space = "Lab",
name="Mantel r")
}
melted_cormat$value <- round(melted_cormat$value, 2)
melted_cormat$Var2 <- as.character(melted_cormat$Var2)
# melted_cormat$Var2[melted_cormat$Var2 == "Simka"] <- glue("*Simka*")
ggheatmap <- ggplot(melted_cormat, aes(factor(Var2, c(tool_names, glue("*Simka*"))), factor(Var1, c(tool_names, glue("*Simka*"))), fill = value))+
geom_tile(color = "white")+
scale_fill_special +
theme_minimal()+ # minimal theme
theme(axis.text.x = element_markdown(angle = 45, vjust = 1,
size = 12, hjust = 1),
axis.text.y = element_text(size = 12))+
coord_fixed()
ggheatmap +
geom_text(aes(factor(Var2, c(tool_names, glue("*Simka*"))), factor(Var1, c(tool_names, glue("*Simka*"))), label = paste0(value, "\n", stars)), color = "black", size = 4) +
theme(
axis.title.x = element_blank(),
axis.title.y = element_blank(),
panel.grid.major = element_blank(),
panel.border = element_blank(),
panel.background = element_blank(),
axis.ticks = element_blank(),
legend.justification = c(1, 0),
legend.position = c(0.57, 0.75),
legend.direction = "horizontal",
legend.title=element_text(size=14)) +
guides(fill = guide_colorbar(barwidth = 5.5, barheight = 1,
title.position = "top", title.hjust = 0.5))
ncbi_only <- ifelse(ncbi_only, "NCBI_only", "all_taxa")
dir.create(file.path("figures/beta_mantel/",dataset,"/"), showWarnings = FALSE)
if (core_only) {
ggsave(paste0("figures/beta_mantel/",dataset,"/",dataset,"_",level_name,"_", ncbi_only, ".png"), width=13, height=11, units = 'cm', dpi=1000, bg='#ffffff')
} else {
ggsave(paste0("figures/beta_mantel/",dataset,"/",dataset,"_",level_name,"_", ncbi_only, "_all_tools.png"), width=19.5, height=17.5, units = 'cm', dpi=1000, bg='#ffffff')
}
}
dataset <- "all"
for (level in c(7)) {
print(paste0("Processing ", dataset, " at level ", level))
level_name <- case_when(level == 1 ~ "kingdom",
level == 2 ~ "phylum",
level == 3 ~ "class",
level == 4 ~ "order",
level == 5 ~ "family",
level == 6 ~ "genus",
level == 7 ~ "species")
dir.create(file.path(paste0("figures/beta_mantel/",dataset,"/")), showWarnings = FALSE)
if (!file.exists(paste0("figures/beta_mantel/",dataset,"/",dataset,"_",level_name,"_NCBI_only.png"))) {
grid_bc_mantel(dataset, level, TRUE)
}
if (!file.exists(paste0("figures/beta_mantel/",dataset,"/",dataset,"_",level_name,"_NCBI_only_all_tools.png"))) {
grid_bc_mantel(dataset, level, TRUE, FALSE)
}
if (!file.exists(paste0("figures/beta_mantel/",dataset,"/",dataset,"_",level_name,"_all_taxa.png"))) {
grid_bc_mantel(dataset, level, FALSE)
}
}
for (level in c(7)) {
print(paste0("Processing ", dataset, " at level ", level))
level_name <- case_when(level == 1 ~ "kingdom",
level == 2 ~ "phylum",
level == 3 ~ "class",
level == 4 ~ "order",
level == 5 ~ "family",
level == 6 ~ "genus",
level == 7 ~ "species")
dir.create(file.path(paste0("figures/beta_mantel/",dataset,"/")), showWarnings = FALSE)
if (!file.exists(paste0("figures/beta_mantel/",dataset,"/",dataset,"_",level_name,"_all_taxa_all_tools.png"))) {
grid_bc_mantel(dataset, level, FALSE, FALSE)
}
if (!file.exists(paste0("figures/beta_mantel/",dataset,"/",dataset,"_",level_name,"_all_taxa.png"))) {
grid_bc_mantel(dataset, level, FALSE)
}
}
setwd("~/Documents/GitHub/environmental_methods_comparison/analysis/scripts")
rm(list = ls())
setwd('..')
library(grid)
library(ggplot2)
library(gridExtra)
library(ggplotify)
library(reshape2)
library(tidyr)
library(ggh4x)
library(drc)
library(forcats)
source("scripts/helpers.R")
preprocess_all_simulated()
preprocess_all_truths()
threshold = 0.05
tool_names = c("Centrifuge", "Kraken 2 / Bracken 2", "MetaPhlAn 2", "MetaPhlAn 3", "MetaPhlAn 4", "Metaxa 2", "mOTUs 3", "GTDB-Tk MEGAHIT", "GTDB-Tk metaSPAdes", "PhyloPhlAn MEGAHIT", "PhyloPhlAn metaSPAdes")
tool_core = c("Kraken 2 / Bracken 2", "MetaPhlAn 4", "mOTUs 3", "GTDB-Tk MEGAHIT", "PhyloPhlAn MEGAHIT")
colAdd <- c("#CF9FFF", "#A15BE4", "#00FFFF", "#0061FE", "#1434A4", "#81C784", "#2E7D32", "#FF7300", "#FBB15B", "#AC0911", "#E95420")
col = scale_color_manual(values = colAdd)
fil = scale_fill_manual(values = colAdd)
unknown_taxa = read.csv('databases/ncbi_taxdump/unknown_taxa.tsv', header = F)[,1]
plot_df = data.frame(matrix(nrow = 0, ncol = 6))
colnames(plot_df) <- c("Dataset", "Level", "Type", "Value", "file_name", "Tool")
for (dataset in list.files("simulation_outputs/inputs")) {
unknown_proportion <- ifelse(dataset=="gut", as.character(5), as.character(75))
in_files = list.files(paste0("simulation_outputs/inputs/", dataset, "/true_profile/profiles"))
in_files = paste0("simulation_outputs/inputs/", dataset, "/true_profile/profiles/", in_files)
in_files = in_files[grepl(paste0("simulation_outputs/inputs/", dataset, "/true_profile/profiles/profile\\.n\\.300\\.size\\.7\\.5\\.k\\.100\\.sigma\\.1\\.0\\.up\\.0\\.", unknown_proportion, "\\.mut_rate\\.0\\.0_sample_[0-9].txt"), in_files)]
for (file in in_files) {
profile = read.csv(file, sep='\t', skip = 4)
# No eukaryotes
profile <- profile[!grepl("^2759",profile[,3]),c(1,2,5)]
colnames(profile) <- c("TaxID", "rank", "abundance")
profile$TaxID <- as.integer(profile$TaxID)
for (level in c("superkingdom", "phylum", "class", "order", "family", "genus", "species")) {
level_to_read <- ifelse(level == "superkingdom", "kingdom", level)
level_list <- read.csv(paste0("databases/taxa_lists/", level_to_read, ".tsv"), sep="\t")
for (i in 1:length(tool_names)) {
database_to_look = case_when(i == 1 ~ "centrifuge",
i == 2 ~ "kraken",
i == 3 ~ "metaphlan2",
i == 4 ~ "metaphlan3",
i == 5 ~ "metaphlan4",
i == 6 ~ "metaxa2",
i == 7 ~ "mOTUs3",
i == 8 ~ "gtdbtk",
i == 9 ~ "gtdbtk",
i == 10 ~ "phylophlan3",
i == 11 ~ "phylophlan3")
df_append <- data.frame("Dataset" = dataset,
"Level" = level,
"Type" = c("NCBI available and in database", "NCBI available but not in database", "New NCBI (Unknown)", "New SGB (Unknown)"),
"Value" = c(sum(profile$abundance[profile$rank == level & !(profile$TaxID %in% unknown_taxa) & profile$TaxID %in% level_list[,database_to_look][!is.na(level_list[,database_to_look])]]),
sum(profile$abundance[profile$rank == level & !(profile$TaxID %in% unknown_taxa) & !(profile$TaxID %in% level_list[,database_to_look][!is.na(level_list[,database_to_look])])]),
sum(profile$abundance[profile$rank == level & profile$TaxID %in% unknown_taxa]),
100 - sum(c(profile$abundance[profile$rank == level & !(profile$TaxID %in% unknown_taxa)],
profile$abundance[profile$rank == level & profile$TaxID %in% unknown_taxa]))
),
"file_name" = file,
"Tool" = i
)
plot_df <- rbind(plot_df, df_append)
}
}
}
}
plot_df$Tool <- tool_names[plot_df$Tool]
plot_df <- aggregate(Value~Dataset + Level + Type + Tool, data=plot_df, FUN=mean)
col <- c("#38A061", "#ADD8E6", "#AAAAAA", "#888888")
names(col) <- c("NCBI available and in database", "NCBI available but not in database",  "New NCBI (Unknown)", "New SGB (Unknown)")
fil = scale_fill_manual(values = col)
plot_df$Level <- case_when(plot_df$Level == "superkingdom" ~ "Kingdom",
plot_df$Level == "phylum" ~ "Phylum",
plot_df$Level == "class" ~ "Class",
plot_df$Level == "order" ~ "Order",
plot_df$Level == "family" ~ "Family",
plot_df$Level == "genus" ~ "Genus",
plot_df$Level == "species" ~ "Species"
)
plot_df$Dataset <- case_when(plot_df$Dataset == "gut" ~ "Animal gut",
plot_df$Dataset == "ocean" ~ "Ocean",
plot_df$Dataset == "soil" ~ "Soil")
plot_df <- plot_df[plot_df$Tool %in% c("Centrifuge", "Kraken 2 / Bracken 2", "MetaPhlAn 2", "MetaPhlAn 3", "MetaPhlAn 4", "Metaxa 2", "mOTUs 3", "GTDB-Tk MEGAHIT", "PhyloPhlAn MEGAHIT"),]
plot_df$Tool <- case_when(plot_df$Tool == "GTDB-Tk MEGAHIT" ~ "GTDB-Tk 2",
plot_df$Tool == "PhyloPhlAn MEGAHIT" ~ "PhyloPhlAn 3",
TRUE ~ plot_df$Tool
)
plot_df
tmp <- plot_df[plot_df$Type=="NCBI available but not in database",]
tmp
aggregate(Value ~ Tool, plot_df, FUN=max)
aggregate(Value ~ Tool, tmp, FUN=max)
unknown_taxa = read.csv('databases/ncbi_taxdump/unknown_taxa.tsv', header = F)[,1]
plot_df = data.frame(matrix(nrow = 0, ncol = 6))
colnames(plot_df) <- c("Dataset", "Level", "Type", "Value", "file_name", "Tool")
for (dataset in list.files("simulation_outputs/inputs")) {
unknown_proportion <- ifelse(dataset=="gut", as.character(5), as.character(75))
in_files = list.files(paste0("simulation_outputs/inputs/", dataset, "/true_profile/profiles"))
in_files = paste0("simulation_outputs/inputs/", dataset, "/true_profile/profiles/", in_files)
in_files = in_files[grepl(paste0("simulation_outputs/inputs/", dataset, "/true_profile/profiles/profile\\.n\\.600\\.size\\.7\\.5\\.k\\.100\\.sigma\\.1\\.0\\.up\\.0\\.", unknown_proportion, "\\.mut_rate\\.0\\.0_sample_[0-9].txt"), in_files)]
for (file in in_files) {
profile = read.csv(file, sep='\t', skip = 4)
# No eukaryotes
profile <- profile[!grepl("^2759",profile[,3]),c(1,2,5)]
colnames(profile) <- c("TaxID", "rank", "abundance")
profile$TaxID <- as.integer(profile$TaxID)
for (level in c("superkingdom", "phylum", "class", "order", "family", "genus", "species")) {
level_to_read <- ifelse(level == "superkingdom", "kingdom", level)
level_list <- read.csv(paste0("databases/taxa_lists/", level_to_read, ".tsv"), sep="\t")
for (i in 1:length(tool_names)) {
database_to_look = case_when(i == 1 ~ "centrifuge",
i == 2 ~ "kraken",
i == 3 ~ "metaphlan2",
i == 4 ~ "metaphlan3",
i == 5 ~ "metaphlan4",
i == 6 ~ "metaxa2",
i == 7 ~ "mOTUs3",
i == 8 ~ "gtdbtk",
i == 9 ~ "gtdbtk",
i == 10 ~ "phylophlan3",
i == 11 ~ "phylophlan3")
df_append <- data.frame("Dataset" = dataset,
"Level" = level,
"Type" = c("NCBI available and in database", "NCBI available but not in database", "New NCBI (Unknown)", "New SGB (Unknown)"),
"Value" = c(sum(profile$abundance[profile$rank == level & !(profile$TaxID %in% unknown_taxa) & profile$TaxID %in% level_list[,database_to_look][!is.na(level_list[,database_to_look])]]),
sum(profile$abundance[profile$rank == level & !(profile$TaxID %in% unknown_taxa) & !(profile$TaxID %in% level_list[,database_to_look][!is.na(level_list[,database_to_look])])]),
sum(profile$abundance[profile$rank == level & profile$TaxID %in% unknown_taxa]),
100 - sum(c(profile$abundance[profile$rank == level & !(profile$TaxID %in% unknown_taxa)],
profile$abundance[profile$rank == level & profile$TaxID %in% unknown_taxa]))
),
"file_name" = file,
"Tool" = i
)
plot_df <- rbind(plot_df, df_append)
}
}
}
}
plot_df$Tool <- tool_names[plot_df$Tool]
plot_df <- aggregate(Value~Dataset + Level + Type + Tool, data=plot_df, FUN=mean)
col <- c("#38A061", "#ADD8E6", "#AAAAAA", "#888888")
names(col) <- c("NCBI available and in database", "NCBI available but not in database",  "New NCBI (Unknown)", "New SGB (Unknown)")
fil = scale_fill_manual(values = col)
plot_df$Level <- case_when(plot_df$Level == "superkingdom" ~ "Kingdom",
plot_df$Level == "phylum" ~ "Phylum",
plot_df$Level == "class" ~ "Class",
plot_df$Level == "order" ~ "Order",
plot_df$Level == "family" ~ "Family",
plot_df$Level == "genus" ~ "Genus",
plot_df$Level == "species" ~ "Species"
)
plot_df$Dataset <- case_when(plot_df$Dataset == "gut" ~ "Animal gut",
plot_df$Dataset == "ocean" ~ "Ocean",
plot_df$Dataset == "soil" ~ "Soil")
plot_df <- plot_df[plot_df$Tool %in% c("Centrifuge", "Kraken 2 / Bracken 2", "MetaPhlAn 2", "MetaPhlAn 3", "MetaPhlAn 4", "Metaxa 2", "mOTUs 3", "GTDB-Tk MEGAHIT", "PhyloPhlAn MEGAHIT"),]
plot_df$Tool <- case_when(plot_df$Tool == "GTDB-Tk MEGAHIT" ~ "GTDB-Tk 2",
plot_df$Tool == "PhyloPhlAn MEGAHIT" ~ "PhyloPhlAn 3",
TRUE ~ plot_df$Tool
)
tmp <- plot_df[plot_df$Type=="NCBI available but not in database",]
aggregate(Value ~ Tool, tmp, FUN=max)
setwd("~/Documents/GitHub/environmental_methods_comparison/analysis/scripts")
rm(list = ls())
setwd('..')
library(reshape2)
library(ggplot2)
library(Maaslin2)
library(data.table)
#library(ggtext) # Load these when using 4-parameter logistic, but don't load otherwise; messes with Maaslin
library(glue)
library(Rtsne)
library(ggbeeswarm)
library(ggtext)
source("scripts/helpers.R")
preprocess_all_real()
threshold = 0.05
tool_names = c("Centrifuge", "Kraken 2 / Bracken 2", "MetaPhlAn 2", "MetaPhlAn 3", "MetaPhlAn 4", "Metaxa 2", "mOTUs 3", "GTDB-Tk MEGAHIT", "GTDB-Tk metaSPAdes", "PhyloPhlAn MEGAHIT", "PhyloPhlAn metaSPAdes")
tool_core = c("Kraken 2 / Bracken 2", "MetaPhlAn 4", "mOTUs 3", "GTDB-Tk MEGAHIT", "PhyloPhlAn MEGAHIT")
colAdd <- c("#CF9FFF", "#A15BE4", "#00FFFF", "#0061FE", "#1434A4", "#81C784", "#2E7D32", "#FF7300", "#FBB15B", "#AC0911", "#E95420")
col = scale_color_manual(values = colAdd)
fil = scale_fill_manual(values = colAdd)
dataset <- "acid_mine"
if (!(dataset %in% c("acid_mine", "animal_gut", "cat_gut", "coastal_sediment", "dog_gut", "forest_soil", "human", "saltmarsh", "all"))) {
tool_names <- tool_names[-c(9, 11)]
colAdd <- colAdd[-c(9, 11)]
col = scale_color_manual(values = colAdd)
fil = scale_fill_manual(values = colAdd)
}
set.seed(1)
if (dataset == "all") {
df <- data.frame(matrix(ncol = 3, nrow = 0))
for (dataset_tmp in list.files("real_data_outputs/inputs")[!list.files("real_data_outputs/inputs") %in% c("human", "overall_dists")]) {
if (!(dataset_tmp %in% c("acid_mine", "animal_gut", "cat_gut", "coastal_sediment", "dog_gut", "forest_soil", "human", "saltmarsh"))) {
tool_names_tmp <- tool_names[-c(3, 11)]
} else {
tool_names_tmp <- tool_names
}
data <- preprocess(dataset_tmp, level, real = TRUE, by_dataset = TRUE)
data = lapply(data, renormalize)
data = lapply(data, threshold_sample, threshold)
data = lapply(data, renormalize)
df_tmp <- data.frame(matrix(ncol = ncol(data[[1]]) - 1, nrow = 0))
for (i in 1:length(data)) {
tmp <- data[[i]]
df_tmp[nrow(df_tmp) + 1,] <- c(as.numeric(tmp[tmp$TaxIDs=="UNCLASSIFIED",-1]), rep(NA, ncol(df_tmp) - ncol(tmp) + 1))
}
df_tmp$Methods <- tool_names_tmp
df_tmp <- melt(df_tmp, id.vars = c("Methods"))
df <- rbind(df, df_tmp)
}
} else {
data <- preprocess(dataset, level, real = TRUE, by_dataset = TRUE)
data = lapply(data, renormalize)
data = lapply(data, threshold_sample, threshold)
data = lapply(data, renormalize)
df <- data.frame(matrix(ncol = ncol(data[[1]]) - 1, nrow = 0))
for (i in 1:length(data)) {
tmp <- data[[i]]
df[nrow(df) + 1,] <- c(as.numeric(tmp[tmp$TaxIDs=="UNCLASSIFIED",-1]), rep(NA, ncol(df) - ncol(tmp) + 1))
}
df$Methods <- tool_names
df <- melt(df, id.vars = c("Methods"))
}
level <- 7
if (dataset == "all") {
df <- data.frame(matrix(ncol = 3, nrow = 0))
for (dataset_tmp in list.files("real_data_outputs/inputs")[!list.files("real_data_outputs/inputs") %in% c("human", "overall_dists")]) {
if (!(dataset_tmp %in% c("acid_mine", "animal_gut", "cat_gut", "coastal_sediment", "dog_gut", "forest_soil", "human", "saltmarsh"))) {
tool_names_tmp <- tool_names[-c(3, 11)]
} else {
tool_names_tmp <- tool_names
}
data <- preprocess(dataset_tmp, level, real = TRUE, by_dataset = TRUE)
data = lapply(data, renormalize)
data = lapply(data, threshold_sample, threshold)
data = lapply(data, renormalize)
df_tmp <- data.frame(matrix(ncol = ncol(data[[1]]) - 1, nrow = 0))
for (i in 1:length(data)) {
tmp <- data[[i]]
df_tmp[nrow(df_tmp) + 1,] <- c(as.numeric(tmp[tmp$TaxIDs=="UNCLASSIFIED",-1]), rep(NA, ncol(df_tmp) - ncol(tmp) + 1))
}
df_tmp$Methods <- tool_names_tmp
df_tmp <- melt(df_tmp, id.vars = c("Methods"))
df <- rbind(df, df_tmp)
}
} else {
data <- preprocess(dataset, level, real = TRUE, by_dataset = TRUE)
data = lapply(data, renormalize)
data = lapply(data, threshold_sample, threshold)
data = lapply(data, renormalize)
df <- data.frame(matrix(ncol = ncol(data[[1]]) - 1, nrow = 0))
for (i in 1:length(data)) {
tmp <- data[[i]]
df[nrow(df) + 1,] <- c(as.numeric(tmp[tmp$TaxIDs=="UNCLASSIFIED",-1]), rep(NA, ncol(df) - ncol(tmp) + 1))
}
df$Methods <- tool_names
df <- melt(df, id.vars = c("Methods"))
}
fd
df
source("~/.active-rstudio-document", echo=TRUE)
for (dataset in c(list.files("real_data_outputs/inputs")[!list.files("real_data_outputs/inputs") %in% c("overall_dists")], "all")) {
threshold = 0.05
tool_names = c("Centrifuge", "Kraken 2 / Bracken 2", "MetaPhlAn 2", "MetaPhlAn 3", "MetaPhlAn 4", "Metaxa 2", "mOTUs 3", "GTDB-Tk MEGAHIT", "GTDB-Tk metaSPAdes", "PhyloPhlAn MEGAHIT", "PhyloPhlAn metaSPAdes")
tool_core = c("Kraken 2 / Bracken 2", "MetaPhlAn 4", "mOTUs 3", "GTDB-Tk MEGAHIT", "PhyloPhlAn MEGAHIT")
colAdd <- c("#CF9FFF", "#A15BE4", "#00FFFF", "#0061FE", "#1434A4", "#81C784", "#2E7D32", "#FF7300", "#FBB15B", "#AC0911", "#E95420")
col = scale_color_manual(values = colAdd)
fil = scale_fill_manual(values = colAdd)
if (!(dataset %in% c("acid_mine", "animal_gut", "cat_gut", "coastal_sediment", "dog_gut", "forest_soil", "human", "saltmarsh", "all"))) {
tool_names <- tool_names[-c(9, 11)]
colAdd <- colAdd[-c(9, 11)]
col = scale_color_manual(values = colAdd)
fil = scale_fill_manual(values = colAdd)
}
set.seed(1)
if (dataset == "all") {
df <- data.frame(matrix(ncol = 3, nrow = 0))
for (dataset_tmp in list.files("real_data_outputs/inputs")[!list.files("real_data_outputs/inputs") %in% c("human", "overall_dists")]) {
if (!(dataset_tmp %in% c("acid_mine", "animal_gut", "cat_gut", "coastal_sediment", "dog_gut", "forest_soil", "human", "saltmarsh"))) {
tool_names_tmp <- tool_names[-c(3, 11)]
} else {
tool_names_tmp <- tool_names
}
data <- preprocess(dataset_tmp, level, real = TRUE, by_dataset = TRUE)
data = lapply(data, renormalize)
data = lapply(data, threshold_sample, threshold)
data = lapply(data, renormalize)
df_tmp <- data.frame(matrix(ncol = ncol(data[[1]]) - 1, nrow = 0))
for (i in 1:length(data)) {
tmp <- data[[i]]
df_tmp[nrow(df_tmp) + 1,] <- c(as.numeric(tmp[tmp$TaxIDs=="UNCLASSIFIED",-1]), rep(NA, ncol(df_tmp) - ncol(tmp) + 1))
}
df_tmp$Methods <- tool_names_tmp
df_tmp <- melt(df_tmp, id.vars = c("Methods"))
df <- rbind(df, df_tmp)
}
} else {
data <- preprocess(dataset, level, real = TRUE, by_dataset = TRUE)
data = lapply(data, renormalize)
data = lapply(data, threshold_sample, threshold)
data = lapply(data, renormalize)
df <- data.frame(matrix(ncol = ncol(data[[1]]) - 1, nrow = 0))
for (i in 1:length(data)) {
tmp <- data[[i]]
df[nrow(df) + 1,] <- c(as.numeric(tmp[tmp$TaxIDs=="UNCLASSIFIED",-1]), rep(NA, ncol(df) - ncol(tmp) + 1))
}
df$Methods <- tool_names
df <- melt(df, id.vars = c("Methods"))
}
print(dataset)
print(mean(df$value[!(df$Methods %in% c("GTDB-Tk MEGAHIT", "GTDB-Tk metaSPAdes", "PhyloPhlAn MEGAHIT", "PhyloPhlAn metaSPAdes"))]))
}
rm(list = ls())
setwd('..')
library(grid)
library(ggplot2)
library(gridExtra)
library(ggplotify)
library(reshape2)
library(tidyr)
library(ggh4x)
library(drc)
library(forcats)
source("scripts/helpers.R")
setwd("~/Documents/GitHub/environmental_methods_comparison/analysis/scripts")
rm(list = ls())
setwd('..')
library(grid)
library(ggplot2)
library(gridExtra)
library(ggplotify)
library(reshape2)
library(tidyr)
library(ggh4x)
library(drc)
library(forcats)
source("scripts/helpers.R")
preprocess_all_simulated()
preprocess_all_truths()
threshold = 0.05
tool_names = c("Centrifuge", "Kraken 2 / Bracken 2", "MetaPhlAn 2", "MetaPhlAn 3", "MetaPhlAn 4", "Metaxa 2", "mOTUs 3", "GTDB-Tk MEGAHIT", "GTDB-Tk metaSPAdes", "PhyloPhlAn MEGAHIT", "PhyloPhlAn metaSPAdes")
tool_core = c("Kraken 2 / Bracken 2", "MetaPhlAn 4", "mOTUs 3", "GTDB-Tk MEGAHIT", "PhyloPhlAn MEGAHIT")
colAdd <- c("#CF9FFF", "#A15BE4", "#00FFFF", "#0061FE", "#1434A4", "#81C784", "#2E7D32", "#FF7300", "#FBB15B", "#AC0911", "#E95420")
col = scale_color_manual(values = colAdd)
fil = scale_fill_manual(values = colAdd)
plot_df = data.frame(matrix(nrow = 0, ncol = 5))
colnames(plot_df) <- c("Tool", "Dataset", "Level", "Metric", "Value")
profiles <- remove_non_ncbi(preprocess(dataset, level, FALSE))
dataset <- "soil"
profiles <- remove_non_ncbi(preprocess(dataset, level, FALSE))
level <- 7
profiles <- remove_non_ncbi(preprocess(dataset, level, FALSE))
profiles
tmp <- preprocess_simulation_truths(dataset, level)
tmp
dim(tmp)
rowSums(tmp[,-1])
tmp <- tmp[rowSums(tmp[,-1])>10]
tmp <- tmp[rowSums(tmp[,-1])>10,]
dim(tmp)
tmp
write.csv(tmp, "testout.csv")
getwd()
tmp2 <- profiles[[5]]
tmp2
rowSums(tmp2)
rowSums(tmp2[,-1])
tmp2 <- tmp2[rowSums(tmp2[,-1])>10,]
dim(tmp2)
write.csv(tmp2, "tmp2.csv")
tmp2 <- profiles[[7]]
rowSums(tmp2)
rowSums(tmp2[,-1])
tmp2 <- tmp2[rowSums(tmp2[,-1])>10,]
dim(tmp2)
write.csv(tmp2, "tmp3.csv")
